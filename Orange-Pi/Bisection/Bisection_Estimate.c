#include <stdio.h>
#include <math.h>

// sudo gcc -o Bisection_Estimate Bisection_Estimate.c -lm

// rotation inertia is 0.000141407104


double angle[] = {-50.22, -50.04, -49.86, -49.68, -49.5, -49.32, -49.14, -48.96, -48.78, -48.6, -48.42, -48.24, -48.06, 
                -47.88, -47.7, -47.52, -47.34, -47.16, -46.98, -46.8, -46.62, -46.44, -46.26, -46.08, -45.9, -45.72, -45.54, -45.36, 
                -45.18, -45.0, -44.82, -44.64, -44.46, -44.28, -44.1, -43.92, -43.74, -43.56, -43.38, -43.2, -43.02, -42.84, -42.66, 
                -42.48, -42.3, -42.12, -41.94, -41.76, -41.58, -41.4, -41.22, -41.04, -40.86, -40.68, -40.5, -40.32, -40.14, -39.96, 
                -39.78, -39.6, -39.42, -39.24, -39.06, -38.88, -38.7, -38.52, -38.34, -38.16, -37.98, -37.8, -37.62, -37.44, -37.26, 
                -37.08, -36.9, -36.72, -36.54, -36.36, -36.18, -36.0, -35.82, -35.64, -35.46, -35.28, -35.1, -34.92, -34.74, -34.56, 
                -34.38, -34.2, -34.02, -33.84, -33.66, -33.48, -33.3, -33.12, -32.94, -32.76, -32.58, -32.4, -32.22, -32.04, -31.86, 
                -31.68, -31.5, -31.32, -31.14, -30.96, -30.78, -30.6, -30.42, -30.24, -30.06, -29.88, -29.7, -29.52, -29.34, -29.16, 
                -28.98, -28.8, -28.62, -28.44, -28.26, -28.08, -27.9, -27.72, -27.54, -27.36, -27.18, -27.0, -26.82, -26.64, -26.46, 
                -26.28, -26.1, -25.92, -25.74, -25.56, -25.38, -25.2, -25.02, -24.84, -24.66, -24.48, -24.3, -24.12, -23.94, -23.76, 
                -23.58, -23.4, -23.22, -23.04, -22.86, -22.68, -22.5, -22.32, -22.14, -21.96, -21.78, -21.6, -21.42, -21.24, -21.06, 
                -20.88, -20.7, -20.52, -20.34, -20.16, -19.98, -19.8, -19.62, -19.44, -19.26, -19.08, -18.9, -18.72, -18.54, -18.36, 
                -18.18, -18.0, -17.82, -17.64, -17.46, -17.28, -17.1, -16.92, -16.74, -16.56, -16.38, -16.2, -16.02, -15.84, -15.66, 
                -15.48, -15.3, -15.12, -14.94, -14.76, -14.58, -14.4};

double velocity[] = {2.83, 2.98, 3.11, 2.96, 2.97, 2.98, 2.86, 2.98, 3.15, 3.01, 2.97, 2.95, 2.96, 2.87, 3.07, 2.95, 
                2.95, 2.96, 2.97, 2.83, 2.96, 3.11, 2.97, 2.96, 2.95, 2.85, 2.96, 3.09, 2.96, 2.95, 2.92, 2.92, 2.82, 3.09, 2.94, 
                2.94, 2.94, 2.96, 2.84, 2.98, 3.09, 2.93, 2.93, 2.94, 2.93, 2.8, 2.91, 2.93, 3.06, 2.93, 2.95, 2.84, 3.06, 2.8, 
                3.08, 2.93, 2.9, 2.91, 2.81, 3.05, 2.91, 2.93, 2.94, 2.93, 2.8, 3.05, 2.8, 3.03, 2.91, 2.92, 2.92, 2.77, 2.9, 
                3.06, 2.92, 2.9, 2.91, 2.79, 2.91, 3.04, 2.91, 2.92, 2.89, 2.89, 2.79, 3.04, 2.87, 2.89, 2.91, 2.9, 2.75, 2.9, 
                3.03, 2.89, 2.9, 2.91, 2.89, 2.75, 2.89, 3.05, 2.9, 2.86, 2.87, 2.77, 2.89, 3.01, 2.88, 2.88, 2.86, 2.75, 2.9, 
                3.01, 2.86, 2.88, 2.89, 2.88, 2.86, 2.87, 2.87, 2.88, 2.87, 2.75, 3.0, 2.86, 2.87, 2.89, 2.86, 2.85, 2.75, 3.02, 
                2.75, 2.99, 2.86, 2.86, 2.74, 2.99, 2.86, 2.85, 2.83, 2.85, 2.76, 2.98, 2.72, 2.98, 2.86, 2.84, 2.85, 2.73, 2.85, 
                2.97, 2.85, 2.87, 2.83, 2.72, 2.85, 2.97, 2.83, 2.84, 2.85, 2.73, 2.83, 2.97, 2.84, 2.83, 2.83, 2.85, 2.82, 2.82, 
                2.84, 2.85, 2.84, 2.83, 2.84, 2.83, 2.83, 2.82, 2.83, 2.82, 2.8, 2.84, 2.83, 2.82, 2.82, 2.85, 2.84, 2.81, 2.82, 
                2.82, 2.83, 2.82, 2.71, 2.93, 2.8, 2.81, 2.84, 2.82, 2.8, 2.69, 2.96, 2.81};

double time[] = {0.00000, 0.00106, 0.00207, 0.00313, 0.00419, 0.00524, 0.00634, 0.00740, 0.00839, 0.00944, 0.01050, 
                0.01156, 0.01262, 0.01372, 0.01474, 0.01581, 0.01687, 0.01794, 0.01899, 0.02011, 0.02117, 0.02218, 0.02323, 0.02430, 
                0.02536, 0.02646, 0.02753, 0.02854, 0.02960, 0.03067, 0.03174, 0.03282, 0.03393, 0.03495, 0.03602, 0.03709, 0.03816, 
                0.03922, 0.04033, 0.04138, 0.04240, 0.04347, 0.04455, 0.04562, 0.04669, 0.04781, 0.04889, 0.04996, 0.05099, 0.05206, 
                0.05312, 0.05423, 0.05526, 0.05638, 0.05740, 0.05847, 0.05956, 0.06064, 0.06175, 0.06278, 0.06386, 0.06494, 0.06600, 
                0.06708, 0.06820, 0.06923, 0.07035, 0.07139, 0.07247, 0.07354, 0.07462, 0.07575, 0.07684, 0.07787, 0.07894, 0.08003, 
                0.08111, 0.08223, 0.08331, 0.08435, 0.08543, 0.08650, 0.08759, 0.08868, 0.08980, 0.09084, 0.09193, 0.09302, 0.09410, 
                0.09518, 0.09632, 0.09741, 0.09844, 0.09953, 0.10062, 0.10169, 0.10278, 0.10393, 0.10501, 0.10604, 0.10713, 0.10822, 
                0.10932, 0.11045, 0.11154, 0.11258, 0.11367, 0.11476, 0.11586, 0.11700, 0.11808, 0.11913, 0.12023, 0.12132, 0.12240, 
                0.12350, 0.12459, 0.12569, 0.12678, 0.12787, 0.12897, 0.13011, 0.13116, 0.13226, 0.13335, 0.13444, 0.13554, 0.13665, 
                0.13779, 0.13883, 0.13997, 0.14102, 0.14212, 0.14322, 0.14437, 0.14542, 0.14652, 0.14762, 0.14873, 0.14983, 0.15097, 
                0.15202, 0.15317, 0.15423, 0.15532, 0.15643, 0.15753, 0.15868, 0.15979, 0.16084, 0.16194, 0.16304, 0.16415, 0.16530, 
                0.16640, 0.16746, 0.16857, 0.16968, 0.17078, 0.17193, 0.17304, 0.17410, 0.17520, 0.17631, 0.17742, 0.17853, 0.17964, 
                0.18076, 0.18186, 0.18297, 0.18407, 0.18518, 0.18629, 0.18740, 0.18851, 0.18963, 0.19074, 0.19185, 0.19297, 0.19408, 
                0.19519, 0.19631, 0.19742, 0.19853, 0.19963, 0.20075, 0.20187, 0.20298, 0.20409, 0.20520, 0.20636, 0.20743, 0.20855, 
                0.20967, 0.21078, 0.21189, 0.21301, 0.21418, 0.21525, 0.21636};


float fun(float err_t, float err_angle, float cur_velocity, float rotation_inertia)
{
    float damp = 0.0000378;
    return err_angle - (cur_velocity * err_t + ((damp * cur_velocity / 2 /rotation_inertia) * err_t * err_t));
}

void bisection (float *x, float a, float b, int *itr)
{
    *x=(a+b)/2;
    ++(*itr);
    printf("Iteration No.%3d, rotation inertia = %7.8f Kg·m²\n", *itr, *x);
}

int main ()
{ 
    float initial_inertia_1 = 1.0, initial_inertia_2 = 0.00001;
    float estitated_inertia = 0.0, estitated_inertia1 = 0.0;
    float err_angle = 0.0, err_t = 0.0, cur_velocity = 0.0;
    float allerr = 0.0002;
    int matrix_index = 500;
    int itr = 0;
    int maxmitr = 20;


    bisection (&estitated_inertia, initial_inertia_1, initial_inertia_2, &itr);
    do
    {
        err_angle = (angle[matrix_index + 1] - angle[matrix_index]) * M_PI / 180;
        err_t = time[matrix_index + 1] - time[matrix_index];
        cur_velocity = velocity[matrix_index];

        if (fun(err_t, err_angle, cur_velocity, initial_inertia_1) * fun(err_t, err_angle, cur_velocity, estitated_inertia) < 0)
            initial_inertia_2 = estitated_inertia;
        else
            initial_inertia_1 = estitated_inertia;

        bisection (&estitated_inertia1, initial_inertia_1, initial_inertia_2, &itr);
        if (fabs(estitated_inertia1 - estitated_inertia) < allerr)
        {
            printf("After %d iterations, rotation inertia = %6.8f Kg·m²\n", itr, estitated_inertia1);
            return 0;
        }

        estitated_inertia = estitated_inertia1;
        matrix_index++;
    }
    while (itr < maxmitr);
    printf("The solution does not converge or iterations are not sufficient");
    return 1;

}
